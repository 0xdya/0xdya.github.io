<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <style>
  *{
    box-sizing: border-box;
  }
    body {
      background-color: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
      margin: 0 auto;
      max-width: 600px;
    }
    .profile-header {
      position: relative;
      height: 200px;
      background-color: #1c1c1c;
    }
    .banner-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-pic {
      position: absolute;
      bottom: -50px;
      left: 20px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid #000;
      object-fit: cover;
    }
    .container {
      padding: 52px 20px 20px;
    }
    .name-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .name-section span {
      font-size: 22px;
      font-weight: bold;
    }
    .edit-icon {
      cursor: pointer;
      font-size: 18px;
      color: #1da1f2;
      position: absolute;
      right: 1rem;
    }
    #displayNameInput, #saveBtn {
      display: none;
    }
    #displayNameInput {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
    }
    #saveBtn {
      margin-top: 16px;
      padding: 10px 20px;
      background: #1da1f2;
      border: none;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    #saveBtn:hover {
      background: #1991da;
    }
    .sectionbtn{
      display: flex;
      gap: 8px;
      padding: 0 8px;
      position: fixed;
      right: 50%;
      transform: translateX(50%);
      bottom: 1rem;
      width: 100%;
    }
    #logoutBtn, #editBtn{
      background: transparent;
      color: #ededed;
      border: 1px solid beige;
      border-radius: 8px;
      padding: 4px 1rem;
      font-size: 1.2rem;
      backdrop-filter: blur(4px);
      width: 80%;
      display: none;
    }
    #editBtn{
      bottom: 4rem !important;
    }
    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .edit-field {
  display: none;
  width: 100%;
  margin-top: 12px;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #111;
  color: #fff;
}

.edit-btn {
  display: none;
  width: 100%;
  margin-top: 10px;
  padding: 10px 20px;
  background: #1da1f2;
  border: none;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

.edit-btn:hover {
  background: #1991da;
}
#displayBioInput{
  margin: 1rem 0;
}
#profileContainer{
  position: relative;
  height: 100vh;
  display: none;
}
ion-icon{
  margin-bottom: -2px;
}
svg {
    width: 14px;
    fill: #0af;
    margin-bottom: -2px;
  }
  </style>
</head>
<body>

<div id="loading">
  <img width="40" src="../img/load.gif" />
</div>

<div id="profileContainer" >
  <div class="profile-header">
    <img class="banner-img" src="../img/jak.gif" alt="Banner" />
    <img id="photoPreview" class="profile-pic"/>
  </div>
  <div class="container">
<div class="name-section">
  <span id="currentName"></span>
  <span id="roleIcons"></span> <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
</div>
<div id="displayBioInput"></div>
<div id="statusEl"></div>
<input type="text" id="displayNameInput" class="edit-field" placeholder="new name " />
<textarea id="bioInput" class="edit-field" placeholder="new bio " rows="3"></textarea>
<button id="saveAllBtn" class="edit-btn">save</button>

  </div>
<section class="sectionbtn">
<button id="logoutBtn">logout  </button>
<button id="editBtn">Edit profile</button>
</section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyC2U0aM8mUrYoDI0R9pYbzQZk1g9zd96O0",
    authDomain: "oxdyaa.firebaseapp.com",
    projectId: "oxdyaa",
    storageBucket: "oxdyaa.appspot.com",
    messagingSenderId: "604062703590",
    appId: "1:604062703590:web:924c0cbd8a988f4fcf8027"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM elements
  const currentName = document.getElementById("currentName");
  const roleIcons   = document.getElementById("roleIcons");
  const editBtn     = document.getElementById("editBtn");
  const photoPreview = document.getElementById("photoPreview");
  const loading     = document.getElementById("loading");
  const profileContainer = document.getElementById("profileContainer");
  const logoutBtn   = document.getElementById("logoutBtn");
  const displayNameInput = document.getElementById("displayNameInput");
  const displayBioInput = document.getElementById("displayBioInput");
  const bioInput    = document.getElementById("bioInput");
  const statusEl    = document.getElementById("statusEl");
  const saveAllBtn  = document.getElementById("saveAllBtn");

  // Determine username from URL
  let usernameFromURL = window.location.pathname.startsWith("/@")
    ? window.location.pathname.slice(2)
    : "profile";

  // Monitor auth state
  onAuthStateChanged(auth, async (user) => {
    try {
      if (!user && usernameFromURL === "profile") {
        showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (user && usernameFromURL === "profile") {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists() && snap.data().name) {
          window.location.replace(`/@${encodeURIComponent(snap.data().name)}`);
          return;
        }
      }
      await loadProfile(user);
    } catch (err) {
      console.error("Error loading profile:", err);
      showMessage("ğŸš¨ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
    } finally {
      showProfile();
    }
  });

  // Load and render profile
  async function loadProfile(currentUser) {
    if (usernameFromURL === "profile") {
      showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
      return;
    }

    const q = query(collection(db, "users"), where("name", "==", usernameFromURL));
    const qs = await getDocs(q);
    if (qs.empty) {
      showMessage("ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      return;
    }
    const userDoc = qs.docs[0];
    const data = userDoc.data();
    const isOwner = currentUser && currentUser.uid === userDoc.id;

    // Set name
    currentName.textContent = data.name;
    // Set bio
    displayBioInput.textContent = data.bio;

//const imgSrc = (isOwner && currentUser?.photoURL) || data.photo || "../img/user.jpg";
const imgSrc = (isOwner && currentUser?.photo) || data.photo ;

const img = new Image();
img.onload = () => {
  photoPreview.src = imgSrc;
  showProfile();
};
img.src = imgSrc;

// Render role and verification icons
roleIcons.innerHTML = "";
const role = data.role || "";
const isVerified = data.verified === true;

let iconsHTML = "";

if (isVerified) {
  iconsHTML += `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.007 2.10377C8.60544 1.65006 7.08181 2.28116 6.41156 3.59306L5.60578 5.17023C5.51004 5.35763 5.35763 5.51004 5.17023 5.60578L3.59306 6.41156C2.28116 7.08181 1.65006 8.60544 2.10377 10.007L2.64923 11.692C2.71404 11.8922 2.71404 12.1078 2.64923 12.308L2.10377 13.993C1.65006 15.3946 2.28116 16.9182 3.59306 17.5885L5.17023 18.3942C5.35763 18.49 5.51004 18.6424 5.60578 18.8298L6.41156 20.407C7.08181 21.7189 8.60544 22.35 10.007 21.8963L11.692 21.3508C11.8922 21.286 12.1078 21.286 12.308 21.3508L13.993 21.8963C15.3946 22.35 16.9182 21.7189 17.5885 20.407L18.3942 18.8298C18.49 18.6424 18.6424 18.49 18.8298 18.3942L20.407 17.5885C21.7189 16.9182 22.35 15.3946 21.8963 13.993L21.3508 12.308C21.286 12.1078 21.286 11.8922 21.3508 11.692L21.8963 10.007C22.35 8.60544 21.7189 7.08181 20.407 6.41156L18.8298 5.60578C18.6424 5.51004 18.49 5.35763 18.3942 5.17023L17.5885 3.59306C16.9182 2.28116 15.3946 1.65006 13.993 2.10377L12.308 2.64923C12.1078 2.71403 11.8922 2.71404 11.692 2.64923L10.007 2.10377ZM6.75977 11.7573L8.17399 10.343L11.0024 13.1715L16.6593 7.51465L18.0735 8.92886L11.0024 15.9999L6.75977 11.7573Z"></path></svg>`;
}

if (role === "admin") {
  iconsHTML += ` <ion-icon name="build-outline" style="color:gold;font-size:20px" title="Admin"></ion-icon> `;
} else if (role === "developer") {
  iconsHTML += `  <ion-icon name="code-slash-outline" style="color:violet;font-size:20px" title="Developer"></ion-icon> `;
}

roleIcons.innerHTML = iconsHTML;


    // Last login status
    if (data.lastLogin?.toDate) {
      const lastLoginDate = data.lastLogin.toDate();
      const diffSec = Math.floor((new Date() - lastLoginDate) / 1000);
      statusEl.style.fontSize = "14px";
      statusEl.style.color = diffSec < 60 ? "lime" : "#aaa";
      statusEl.style.marginTop = "4px";
      statusEl.textContent = diffSec < 60 ? "online" : `last seen ${formatTimeAgo(diffSec)}`;
      profileContainer.querySelector(".container").appendChild(statusEl);
    }

    // Owner-specific actions
    if (isOwner) {
      editBtn.style.display = "inline-block";
      logoutBtn.style.display = "block";

      let isEditing = false;
      editBtn.onclick = () => {
        isEditing = !isEditing;
        displayNameInput.style.display = isEditing ? "block" : "none";
        bioInput.style.display         = isEditing ? "block" : "none";
        saveAllBtn.style.display       = isEditing ? "inline-block" : "none";
        displayNameInput.value         = data.name || "";
        bioInput.value                 = data.bio || "";
        editBtn.textContent            = isEditing ? "save" : "Edit profile";
      };

      saveAllBtn.onclick = async () => {
        const newName = displayNameInput.value.trim();
        const newBio  = bioInput.value.trim().slice(0, 200);
        if (!newName) return alert("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù….");

        const snapCheck = await getDocs(
          query(collection(db, "users"), where("name", "==", newName))
        );
        const nameTaken = !snapCheck.empty && snapCheck.docs[0].id !== currentUser.uid;
        if (nameTaken) return alert("âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.");

        try {
          await updateProfile(currentUser, { displayName: newName });
          await setDoc(doc(db, "users", currentUser.uid), {
            ...data,
            name: newName,
            bio: newBio,
            photo: currentUser.photo || data.photo
          }, { merge: true });

          alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
          currentName.textContent = newName;
        } catch (err) {
          console.error("Save error:", err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.");
        }
      };

      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "/";
      };
    }
  }

  // Helpers
  function formatTimeAgo(sec) {
    if (sec < 3600) return `${Math.floor(sec / 60)} min ago`;
    if (sec < 86400) return `${Math.floor(sec / 3600)} hours ago`;
    return `${Math.floor(sec / 86400)} days ago`;
  }

  function showMessage(msg) {
    profileContainer.innerHTML =
      `<div style="text-align:center;padding:100px 20px;font-size:22px">${msg}</div>`;
  }

  function showProfile() {
    loading.style.display         = "none";
    profileContainer.style.display = "block";
  }
</script>

<!-- bac
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC2U0aM8mUrYoDI0R9pYbzQZk1g9zd96O0",
  authDomain: "oxdyaa.firebaseapp.com",
  projectId: "oxdyaa",
  storageBucket: "oxdyaa.appspot.com",
  messagingSenderId: "604062703590",
  appId: "1:604062703590:web:924c0cbd8a988f4fcf8027"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const currentName = document.getElementById("currentName");
const editBtn = document.getElementById("editBtn");
const photoPreview = document.getElementById("photoPreview");
const loading = document.getElementById("loading");
const profileContainer = document.getElementById("profileContainer");
const logoutBtn = document.getElementById("logoutBtn");
const displayNameInput = document.getElementById("displayNameInput");
const bioInput = document.getElementById("bioInput");
const saveAllBtn = document.getElementById("saveAllBtn");

let usernameFromURL = window.location.pathname.startsWith("/@")
  ? window.location.pathname.substring(2)
  : "profile";

onAuthStateChanged(auth, async (user) => {
  if (!user && usernameFromURL === "profile") {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }

  if (user && usernameFromURL === "profile") {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      const name = userDoc.data().name;
      if (name) {
        window.location.href = `/@${encodeURIComponent(name)}`;
        return;
      }
    }
  }

  await loadProfile(user);
});

async function loadProfile(currentUser) {
  if (!usernameFromURL || usernameFromURL === "profile") {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    return;
  }

  const q = query(collection(db, "users"), where("name", "==", usernameFromURL));
  const querySnapshot = await getDocs(q);
  if (querySnapshot.empty) return showMessage("ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

  const userDoc = querySnapshot.docs[0];
  const data = userDoc.data();
  const isOwner = currentUser && currentUser.uid === userDoc.id;
const roleIcons = document.getElementById("roleIcons");
const role = data.role || "";

  currentName.textContent = data.name || usernameFromURL;
roleIcons.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª


if (role === "admin") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="crown" style="color: gold; font-size: 20px;"></ion-icon>
  `;
} else if (role === "developer") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="code-slash" style="color: violet; font-size: 20px;"></ion-icon>
  `;
}

if (role === "admin") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="crown" style="color: gold; font-size: 20px;"></ion-icon>
  `;
} else if (role === "developer") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="code-slash" style="color: violet; font-size: 20px;"></ion-icon>
  `;
}

  photoPreview.onload = () => showProfile();
  photoPreview.onerror = () => showProfile();
  photoPreview.src = (isOwner && currentUser?.photoURL) || data.photo || "../img/user.jpg";
    
  // Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
if (data.lastLogin?.toDate) {
  const lastLoginDate = data.lastLogin.toDate();
  const now = new Date();
  const diff = Math.floor((now - lastLoginDate) / 1000); // ÙØ±Ù‚ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

  const statusEl = document.createElement("p");
  statusEl.style.fontSize = "14px";
  statusEl.style.color = diff < 60 ? "lime" : "#aaa";
  statusEl.style.marginTop = "4px";
  statusEl.textContent = diff < 60 ? "online" : `last seen ${formatTimeAgo(diff)}`;
  profileContainer.querySelector(".container").appendChild(statusEl);
}
function formatTimeAgo(seconds) {
  if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
  return `${Math.floor(seconds / 86400)} days ago`;
}

if (isOwner) {
  editBtn.style.display = "inline-block";
  logoutBtn.style.display = "block";

  let isEditing = false;

  // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  editBtn.onclick = () => {
  isEditing = !isEditing;
  displayNameInput.style.display = isEditing ? "block" : "none";
  saveBtn.style.display = isEditing ? "inline-block" : "none";
  bioInput.style.display = isEditing ? "block" : "none";
  bioSaveBtn.style.display = isEditing ? "inline-block" : "none";
  displayNameInput.value = data.name || "";
  bioInput.value = data.bio || "";
  editBtn.textContent = isEditing ? "âœ”" : "âœ";
};



saveAllBtn.onclick = async () => {
  const newName = displayNameInput.value.trim();
  const newBio = bioInput.value.trim().slice(0, 200);

  const valid = /^[a-zA-Z0-9._-]{3,20}$/.test(newName);
  if (!valid) return alert("âš ï¸ Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­.");

  const checkName = await getDocs(query(collection(db, "users"), where("name", "==", newName)));
  const taken = !checkName.empty && checkName.docs[0].id !== currentUser.uid;
  if (taken) return alert("âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.");

  await updateProfile(currentUser, { displayName: newName });

  await setDoc(doc(db, "users", currentUser.uid), {
    ...data,
    name: newName,
    bio: newBio,
    photo: currentUser.photoURL || data.photo
  }, { merge: true });

  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
  location.reload();
};


  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  logoutBtn.onclick = async () => {
    await signOut(auth);
    window.location.href = "/";
  };
}

}

function showMessage(msg) {
  profileContainer.innerHTML = `<div style="text-align:center;padding:100px 20px;font-size:22px">${msg}</div>`;
  showProfile();
}

function showProfile() {
  loading.style.display = "none";
  profileContainer.style.display = "block";
}
</script>
-->

</body>
</html>
