<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="../css/en.css">
  <style>
  *{
    box-sizing: border-box;
  }
    body {
      background-color: var(--profile-bg) !important;
      color: var(--profile-txt);
      margin: 0 auto !important;
      padding: 0 !important;
      max-width: 600px;
    }
    .profile-header {
      position: relative;
      height: 200px;
      background-color: #1c1c1c;
    }
    .banner-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-pic {
      position: absolute;
      bottom: -50px;
      left: 20px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid #000;
      object-fit: cover;
    }
    .profile_container {
      padding: 52px 20px 20px;
    }
    .name-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .name-section span {
      font-size: 22px;
      font-weight: bold;
    }
    .edit-icon {
      cursor: pointer;
      font-size: 18px;
      color: #1da1f2;
      position: absolute;
      right: 1rem;
    }
    #displayNameInput, #saveBtn {
      display: none;
    }
    #displayNameInput {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
    }
    #saveBtn {
      margin-top: 16px;
      padding: 10px 20px;
      background: #1da1f2;
      border: none;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    #saveBtn:hover {
      background: #1991da;
    }
    .sectionbtn{
      display: flex;
      gap: 8px;
      padding: 0 8px;
      position: fixed;
      right: 50%;
      transform: translateX(50%);
      bottom: 1rem;
      width: 100%;
    }
    #logoutBtn, #editBtn{
      background: transparent;
      color: #ededed;
      border: 1px solid beige;
      border-radius: 8px;
      padding: 4px 1rem;
      font-size: 1.2rem;
      backdrop-filter: blur(4px);
      width: 80%;
      display: none;
    }
    #editBtn{
      bottom: 4rem !important;
    }
    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .edit-field {
  display: block;
  width: 100%;
  margin-top: 12px;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #111;
  color: #fff;
}
    .social-links{
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .edit-field-link {
      max-width: 140px;
      height: 38px;
  margin-top: 12px;
  padding: 0 4px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #111;
  color: #fff;
}

.edit-btn {
  display: none;
  width: 100%;
  margin-top: 10px;
  padding: 10px 20px;
  background: #1da1f2;
  border: none;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

.edit-btn:hover {
  background: #1991da;
}
#displayBioInput{
  margin: 1rem 0;
}
#profileContainer{
  position: relative;
  height: 100vh;
  display: none;
}
ion-icon{
  font-size: 18px;
  margin-bottom: -2px;
}
  .imgsvg{
    width: 18px !important;
    height: 18px !important;
    margin-bottom: -2px;
  }
  .theme_toggle_container{
    display: none ;
  }
  #roleIcons{
    display: flex;
    gap: 4px;
  }
  </style>
</head>
<body>

<div id="loading">
  <img width="40" src="../img/load.gif" />
</div>

<div id="profileContainer" >
  <div class="profile-header">
    <img id="bannerImg"class="banner-img" alt="Banner" />
    <img id="photoPreview" class="profile-pic"/>
  </div>
  <div class="profile_container">
<div class="name-section">
  <span id="currentName"></span>
  <span id="roleIcons"></span> 
</div>
<div id="statusEl"></div>
<div id="displayBioInput"></div>
<div id="socialLinks" class="social-links"></div>

<section id="edit_section">
<input type="text" id="displayNameInput" class="edit-field" placeholder="new name " />
<textarea id="bioInput" class="edit-field" placeholder="new bio " rows="3"></textarea>

<!-- social links -->
<div id="addSocialForm" class="social-link-form">
  <select class="edit-field-link" id="platformSelect">
    <option value="twitter">Twitter</option>
    <option value="instagram">Instagram</option>
    <option value="facebook">FaceBook</option>
    <option value="github">GitHub</option>
    <option value="youtube">YouTube</option>
    <option value="linkedin">LinkedIn</option>
    <option value="email">Email</option>
  </select>
  <input type="text" id="socialUsernameInput"  class="edit-field-link" placeholder="@your_name" />
  <button id="saveSocialBtn" class="edit-field-link">üíæ save</button>
  
</div>

<button id="saveAllBtn" class="edit-btn">save</button>
</section>
  </div>
<section class="sectionbtn">
<button id="logoutBtn">logout  </button>
<button id="editBtn"> Edit profile</button>
</section>
</div>
  <div class="theme_toggle_container">
      <button id="themeToggle"><ion-icon name="contrast-outline"></ion-icon></button>
      <a href="report/" class="bug"><ion-icon name="bug-outline"></ion-icon></a>
      <a href="./info/" class="bug"><ion-icon name="document-text-outline"></ion-icon></a>
      <a href="./archive/" class="bug"><ion-icon name="archive-outline"></ion-icon></a>
      <div class="dropdown" id="themeDropdown">
        <button data-theme="light">Light</button>
        <button data-theme="dark">Dark</button>
        <button data-theme="system">System</button>
      </div>
    </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    setDoc,
    onSnapshot,
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC2U0aM8mUrYoDI0R9pYbzQZk1g9zd96O0",
    authDomain: "oxdyaa.firebaseapp.com",
    projectId: "oxdyaa",
    storageBucket: "oxdyaa.appspot.com",
    messagingSenderId: "604062703590",
    appId: "1:604062703590:web:924c0cbd8a988f4fcf8027"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM elements
  const currentName       = document.getElementById("currentName");
  const roleIcons         = document.getElementById("roleIcons");
  const editBtn           = document.getElementById("editBtn");
  const photoPreview      = document.getElementById("photoPreview");
  const loading           = document.getElementById("loading");
  const profileContainer  = document.getElementById("profileContainer");
  const logoutBtn         = document.getElementById("logoutBtn");
  const displayNameInput  = document.getElementById("displayNameInput");
  const displayBioInput   = document.getElementById("displayBioInput");
  const edit_section   = document.getElementById("edit_section");
  const bannerImg = document.getElementById("bannerImg");
  const bioInput          = document.getElementById("bioInput");
  const statusEl          = document.getElementById("statusEl");
  const saveAllBtn        = document.getElementById("saveAllBtn");

  // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ URL
  let usernameFromURL = window.location.pathname.startsWith("/@")
    ? window.location.pathname.slice(2)
    : "profile";

displayNameInput.addEventListener("input", () => {
  // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ÿ•ŸÑŸâ _
  displayNameInput.value = displayNameInput.value.replace(/\s+/g, "_");

  // ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÅŸÇÿ∑ ÿ®ÿßŸÑÿ≠ÿ±ŸàŸÅ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸàÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸàÿßŸÑÿ¥ÿ±ÿ∑ÿ© ÿßŸÑÿ≥ŸÅŸÑŸäÿ©
  displayNameInput.value = displayNameInput.value.replace(/[^\u0621-\u064A\u0660-\u0669a-zA-Z0-9_]/g, "");
});

  // ŸÖÿ™ÿßÿ®ÿπÿ© ÿ≠ÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
  onAuthStateChanged(auth, async (user) => {
    try {
      if (!user && usernameFromURL === "profile") {
        showMessage("‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã.");
        return;
      }

      if (user && usernameFromURL === "profile") {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists() && snap.data().name) {
          window.location.replace(`/@${encodeURIComponent(snap.data().name)}`);
          return;
        }
      }

      loadProfile(user);
    } catch (err) {
      console.error("Error loading profile:", err);
      showMessage("üö® ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.");
    } 
    
  });

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ ŸàŸÖÿ±ÿßŸÇÿ®ÿ™Ÿá
async function loadProfile(currentUser) {
  if (usernameFromURL === "profile") {
    showMessage("‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã.");
    return;
  }

  const q = query(collection(db, "users"), where("name", "==", usernameFromURL));
  onSnapshot(q, async (qs) => {
    if (qs.empty) {
      showMessage("üö´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.");
      return;
    }
    const userDoc = qs.docs[0];
    const data = userDoc.data();
    const isOwner = currentUser && currentUser.uid === userDoc.id;
    currentName.textContent = data.name;
    displayBioInput.textContent = data.bio;
    bannerImg.src = data.banner || null;
    const imgSrc = (isOwner && currentUser?.photo) || data.photo || "../img/user.jpg";
    const img = new Image();
    img.onload = () => {
      photoPreview.src = imgSrc;
      showProfile();
    };
    img.src = imgSrc;

    // ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™
    roleIcons.innerHTML = "";
    const role = data.role || "";
  const isVerified = data.verified === true;
  let iconsHTML = "";
    if (isVerified) {
      iconsHTML += `<img src="../badges/verf.svg" class="imgsvg">`;
    }
    if (role === "admin") {
      iconsHTML += `<img src="../badges/server-owner.svg" class="imgsvg">`;
    } else if (role === "dev") {
      iconsHTML += `<img src="https://0xdya.vercel.app/badges/active-developer.svg" class="imgsvg">`;
    }
    roleIcons.innerHTML = iconsHTML;
    // ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ
    if (data.lastLogin?.toDate) {
      const lastLoginDate = data.lastLogin.toDate();
      const diffSec = Math.floor((new Date() - lastLoginDate) / 1000);
      statusEl.style.fontSize = "14px";
      statusEl.style.color = diffSec < 60 ? "lime" : "#aaa";
      statusEl.style.marginTop = "4px";
      statusEl.textContent = diffSec < 60
        ? "online"
        : `last seen ${formatTimeAgo(diffSec)}`;
    }

    // ‚ö°Ô∏è ÿ±Ÿàÿßÿ®ÿ∑ ÿßŸÑÿ≥Ÿàÿ¥ŸäÿßŸÑ ŸÖŸäÿØŸäÿß
    const socialLinksDiv = document.getElementById("socialLinks");
    const addSocialForm = document.getElementById("addSocialForm");
    const platformSelect = document.getElementById("platformSelect");
    const socialUsernameInput = document.getElementById("socialUsernameInput");
    const saveSocialBtn = document.getElementById("saveSocialBtn");

    let userSocials = data.socials || {};

    function renderSocials() {
  socialLinksDiv.innerHTML = "";
  for (const platform in userSocials) {
    const username = userSocials[platform];
    let url = "";
    let icon = "";

    if (platform === "twitter") {
      url = `https://x.com/${username}`;
      icon = "logo-twitter";
    } else if (platform === "github") {
      url = `https://github.com/${username}`;
      icon = "logo-github";
    } else if (platform === "linkedin") {
      url = `https://linkedin.com/in/${username}`;
      icon = "logo-linkedin";
    } else if (platform === "faceBook") {
      url = `https://FaceBook.com/${username}`;
      icon = "logo-FaceBook";
    } else if (platform === "instagram") {
      url = `https://instagram.com/${username}`;
      icon = "logo-instageam";
    } else if (platform === "youtube") {
      url = `https://youtube.com/@${username}`;
      icon = "logo-instageam";
    } else if (platform === "email") {
      url = `mailto/@${username}`;
      icon = "email-outline";
    }

    socialLinksDiv.innerHTML += `
        <a href="${url}" target="_blank" style="margin-left:6px;">
        <p class="link_card">
        <ion-icon name="${icon}" style="font-size:18px;"></ion-icon>
        ${platform}</p>
        </a>
    `;
  }
}


    renderSocials();

    // ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑
    if (isOwner) {
      editBtn.style.display = "inline-block";
      logoutBtn.style.display = "block";

      let isEditing = false;

      editBtn.onclick = () => {
        isEditing = !isEditing;
        edit_section.style.display = isEditing ? "block" : "none";
        saveAllBtn.style.display = isEditing ? "inline-block" : "none";
        displayNameInput.value = data.name || "";
        bioInput.value = data.bio || "";
        editBtn.textContent = isEditing ? "close" : "Edit profile";
      };

      saveAllBtn.onclick = async () => {
        const newName = displayNameInput.value.trim();
        const newBio = bioInput.value.trim().slice(0, 200);
        if (!newName) return alert("‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ.");

        const snapCheck = await getDocs(
          query(collection(db, "users"), where("name", "==", newName))
        );
        const nameTaken = !snapCheck.empty && snapCheck.docs[0].id !== currentUser.uid;
        if (nameTaken) return alert("‚ö†Ô∏è ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ.");

        try {
          await updateProfile(currentUser, { displayName: newName });
          await setDoc(doc(db, "users", currentUser.uid), {
            ...data,
            name: newName,
            bio: newBio,
            photo: currentUser.photo || data.photo
          }, { merge: true });

          alert("‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™");
          currentName.textContent = newName;
          window.location.href = "/profile/";
        } catch (err) {
          console.error("Save error:", err);
          alert("‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏.");
        }
      };

      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "/";
      };

      saveSocialBtn.onclick = async () => {
        const platform = platformSelect.value;
        const username = socialUsernameInput.value.trim();
        if (!username) return alert("‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ");

        userSocials[platform] = username;

        try {
          await setDoc(doc(db, "users", currentUser.uid), {
            socials: userSocials
          }, { merge: true });

          alert("‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏");
          renderSocials();
          addSocialForm.style.display = "none";
          socialUsernameInput.value = "";
        } catch (err) {
          console.error(err);
          alert("‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏");
        }
    }
  });
});
}

  // ÿ£ÿØŸàÿßÿ™ ŸÖÿ≥ÿßÿπÿØÿ©
  function formatTimeAgo(sec) {
    if (sec < 3600) return `${Math.floor(sec / 60)} min ago`;
    if (sec < 86400) return `${Math.floor(sec / 3600)} hours ago`;
    return `${Math.floor(sec / 86400)} days ago`;
  }
  function showMessage(msg) {
    profileContainer.innerHTML = `<div style="text-align:center;padding:100px 20px;font-size:22px">${msg}</div>`;
  }
  function showProfile() {
    loading.style.display = "none";
    profileContainer.style.display = "block";
  }
</script>


<script src="../js/script.js"></script>
<script src="../js/user.js"></script>
</body>
</html>