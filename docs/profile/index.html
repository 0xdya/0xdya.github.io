<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <style>
  *{
    box-sizing: border-box;
  }
    body {
      background-color: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
      margin: 0 auto;
      max-width: 600px;
    }
    .profile-header {
      position: relative;
      height: 200px;
      background-color: #1c1c1c;
    }
    .banner-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-pic {
      position: absolute;
      bottom: -50px;
      left: 20px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid #000;
      object-fit: cover;
    }
    .container {
      padding: 52px 20px 20px;
    }
    .name-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .name-section span {
      font-size: 22px;
      font-weight: bold;
    }
    .edit-icon {
      cursor: pointer;
      font-size: 18px;
      color: #1da1f2;
      position: absolute;
      right: 1rem;
    }
    #displayNameInput, #saveBtn {
      display: none;
    }
    #displayNameInput {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
    }
    #saveBtn {
      margin-top: 16px;
      padding: 10px 20px;
      background: #1da1f2;
      border: none;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    #saveBtn:hover {
      background: #1991da;
    }
    .sectionbtn{
      display: flex;
      gap: 8px;
      padding: 0 8px;
      position: absolute;
      right: 50%;
      transform: translateX(50%);
      bottom: 1rem;
      width: 100%;
    }
    #logoutBtn, #editBtn{
      background: transparent;
      color: #ededed;
      border: 1px solid beige;
      border-radius: 8px;
      padding: 4px 1rem;
      font-size: 1.2rem;
      backdrop-filter: blur(4px);
      width: 80%;
      display: none;
    }
    #editBtn{
      bottom: 4rem !important;
    }
    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .edit-field {
  display: none;
  width: 100%;
  margin-top: 12px;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #333;
  background: #111;
  color: #fff;
}

.edit-btn {
  display: none;
  width: 100%;
  margin-top: 10px;
  padding: 10px 20px;
  background: #1da1f2;
  border: none;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

.edit-btn:hover {
  background: #1991da;
}
#displayBioInput{
  margin: 2rem 0 1rem;
}
#profileContainer{
  position: relative;
  height: 100vh;
  display: none;
}
  </style>
</head>
<body>

<div id="loading">
  <img width="40" src="../img/load.gif" />
</div>

<div id="profileContainer" >
  <div class="profile-header">
    <img class="banner-img" src="../img/jak.gif" alt="Banner" />
    <img id="photoPreview" class="profile-pic"/>
  </div>
  <div class="container">
<div class="name-section">
  <span id="currentName"></span>
  <span id="roleIcons"></span> <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
</div>
<div id="displayBioInput"></div>
<input type="text" id="displayNameInput" class="edit-field" placeholder="new name " />
<textarea id="bioInput" class="edit-field" placeholder="new bio " rows="3"></textarea>
<button id="saveAllBtn" class="edit-btn">save</button>

  </div>
<section class="sectionbtn">
<button id="editBtn"> logout</button>
<button id="logoutBtn">Edit profile  </button>
</section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyC2U0aM8mUrYoDI0R9pYbzQZk1g9zd96O0",
    authDomain: "oxdyaa.firebaseapp.com",
    projectId: "oxdyaa",
    storageBucket: "oxdyaa.appspot.com",
    messagingSenderId: "604062703590",
    appId: "1:604062703590:web:924c0cbd8a988f4fcf8027"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM elements
  const currentName = document.getElementById("currentName");
  const roleIcons   = document.getElementById("roleIcons");
  const editBtn     = document.getElementById("editBtn");
  const photoPreview = document.getElementById("photoPreview");
  const loading     = document.getElementById("loading");
  const profileContainer = document.getElementById("profileContainer");
  const logoutBtn   = document.getElementById("logoutBtn");
  const displayNameInput = document.getElementById("displayNameInput");
  const displayBioInput = document.getElementById("displayBioInput");
  const bioInput    = document.getElementById("bioInput");
  const saveAllBtn  = document.getElementById("saveAllBtn");

  // Determine username from URL
  let usernameFromURL = window.location.pathname.startsWith("/@")
    ? window.location.pathname.slice(2)
    : "profile";

  // Monitor auth state
  onAuthStateChanged(auth, async (user) => {
    try {
      if (!user && usernameFromURL === "profile") {
        showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (user && usernameFromURL === "profile") {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists() && snap.data().name) {
          window.location.replace(`/@${encodeURIComponent(snap.data().name)}`);
          return;
        }
      }
      await loadProfile(user);
    } catch (err) {
      console.error("Error loading profile:", err);
      showMessage("ğŸš¨ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
    } finally {
      showProfile();
    }
  });

  // Load and render profile
  async function loadProfile(currentUser) {
    if (usernameFromURL === "profile") {
      showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
      return;
    }

    const q = query(collection(db, "users"), where("name", "==", usernameFromURL));
    const qs = await getDocs(q);
    if (qs.empty) {
      showMessage("ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      return;
    }
    const userDoc = qs.docs[0];
    const data = userDoc.data();
    const isOwner = currentUser && currentUser.uid === userDoc.id;

    // Set name
    currentName.textContent = data.name;
    // Set bio
    displayBioInput.textContent = data.bio;

//const imgSrc = (isOwner && currentUser?.photoURL) || data.photo || "../img/user.jpg";
const imgSrc = (isOwner && currentUser?.photo) || data.photo ;

const img = new Image();
img.onload = () => {
  photoPreview.src = imgSrc;
  showProfile();
};
img.src = imgSrc;

// Render role and verification icons
roleIcons.innerHTML = "";
const role = data.role || "";
const isVerified = data.verified === true;

let iconsHTML = "";

// âœ… Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¥Ø°Ø§ verified
if (isVerified) {
  iconsHTML += `<ion-icon name="checkmark-circle" style="color:#1da1f2;font-size:20px" title="Verified"></ion-icon>`;
}

// ğŸ‘‘ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¯ÙˆØ±
if (role === "admin") {
  iconsHTML += `<ion-icon name="crown" style="color:gold;font-size:20px" title="Admin"></ion-icon>`;
} else if (role === "developer") {
  iconsHTML += `<ion-icon name="code-slash" style="color:violet;font-size:20px" title="Developer"></ion-icon>`;
}

roleIcons.innerHTML = iconsHTML;


    // Last login status
    if (data.lastLogin?.toDate) {
      const lastLoginDate = data.lastLogin.toDate();
      const diffSec = Math.floor((new Date() - lastLoginDate) / 1000);
      const statusEl = document.createElement("p");
      statusEl.style.fontSize = "14px";
      statusEl.style.color = diffSec < 60 ? "lime" : "#aaa";
      statusEl.style.marginTop = "4px";
      statusEl.textContent = diffSec < 60 ? "online" : `last seen ${formatTimeAgo(diffSec)}`;
      profileContainer.querySelector(".container").appendChild(statusEl);
    }

    // Owner-specific actions
    if (isOwner) {
      editBtn.style.display = "inline-block";
      logoutBtn.style.display = "block";

      let isEditing = false;
      editBtn.onclick = () => {
        isEditing = !isEditing;
        displayNameInput.style.display = isEditing ? "block" : "none";
        bioInput.style.display         = isEditing ? "block" : "none";
        saveAllBtn.style.display       = isEditing ? "inline-block" : "none";
        displayNameInput.value         = data.name || "";
        bioInput.value                 = data.bio || "";
        editBtn.textContent            = isEditing ? "âœ”" : "âœ";
      };

      saveAllBtn.onclick = async () => {
        const newName = displayNameInput.value.trim();
        const newBio  = bioInput.value.trim().slice(0, 200);
        if (!newName) return alert("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù….");

        const snapCheck = await getDocs(
          query(collection(db, "users"), where("name", "==", newName))
        );
        const nameTaken = !snapCheck.empty && snapCheck.docs[0].id !== currentUser.uid;
        if (nameTaken) return alert("âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.");

        try {
          await updateProfile(currentUser, { displayName: newName });
          await setDoc(doc(db, "users", currentUser.uid), {
            ...data,
            name: newName,
            bio: newBio,
            photo: currentUser.photo || data.photo
          }, { merge: true });

          alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
          currentName.textContent = newName;
        } catch (err) {
          console.error("Save error:", err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.");
        }
      };

      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "/";
      };
    }
  }

  // Helpers
  function formatTimeAgo(sec) {
    if (sec < 3600) return `${Math.floor(sec / 60)} min ago`;
    if (sec < 86400) return `${Math.floor(sec / 3600)} hours ago`;
    return `${Math.floor(sec / 86400)} days ago`;
  }

  function showMessage(msg) {
    profileContainer.innerHTML =
      `<div style="text-align:center;padding:100px 20px;font-size:22px">${msg}</div>`;
  }

  function showProfile() {
    loading.style.display         = "none";
    profileContainer.style.display = "block";
  }
</script>

<!-- bac 
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC2U0aM8mUrYoDI0R9pYbzQZk1g9zd96O0",
  authDomain: "oxdyaa.firebaseapp.com",
  projectId: "oxdyaa",
  storageBucket: "oxdyaa.appspot.com",
  messagingSenderId: "604062703590",
  appId: "1:604062703590:web:924c0cbd8a988f4fcf8027"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const currentName = document.getElementById("currentName");
const editBtn = document.getElementById("editBtn");
const photoPreview = document.getElementById("photoPreview");
const loading = document.getElementById("loading");
const profileContainer = document.getElementById("profileContainer");
const logoutBtn = document.getElementById("logoutBtn");
const displayNameInput = document.getElementById("displayNameInput");
const bioInput = document.getElementById("bioInput");
const saveAllBtn = document.getElementById("saveAllBtn");

let usernameFromURL = window.location.pathname.startsWith("/@")
  ? window.location.pathname.substring(2)
  : "profile";

onAuthStateChanged(auth, async (user) => {
  if (!user && usernameFromURL === "profile") {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }

  if (user && usernameFromURL === "profile") {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      const name = userDoc.data().name;
      if (name) {
        window.location.href = `/@${encodeURIComponent(name)}`;
        return;
      }
    }
  }

  await loadProfile(user);
});

async function loadProfile(currentUser) {
  if (!usernameFromURL || usernameFromURL === "profile") {
    showMessage("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    return;
  }

  const q = query(collection(db, "users"), where("name", "==", usernameFromURL));
  const querySnapshot = await getDocs(q);
  if (querySnapshot.empty) return showMessage("ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

  const userDoc = querySnapshot.docs[0];
  const data = userDoc.data();
  const isOwner = currentUser && currentUser.uid === userDoc.id;
const roleIcons = document.getElementById("roleIcons");
const role = data.role || "";

  currentName.textContent = data.name || usernameFromURL;
roleIcons.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª


if (role === "admin") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="crown" style="color: gold; font-size: 20px;"></ion-icon>
  `;
} else if (role === "developer") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="code-slash" style="color: violet; font-size: 20px;"></ion-icon>
  `;
}

if (role === "admin") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="crown" style="color: gold; font-size: 20px;"></ion-icon>
  `;
} else if (role === "developer") {
  roleIcons.innerHTML = `
    <ion-icon name="checkmark-circle" style="color: #1da1f2; font-size: 20px;"></ion-icon>
    <ion-icon name="code-slash" style="color: violet; font-size: 20px;"></ion-icon>
  `;
}

  photoPreview.onload = () => showProfile();
  photoPreview.onerror = () => showProfile();
  photoPreview.src = (isOwner && currentUser?.photoURL) || data.photo || "../img/user.jpg";
    
  // Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
if (data.lastLogin?.toDate) {
  const lastLoginDate = data.lastLogin.toDate();
  const now = new Date();
  const diff = Math.floor((now - lastLoginDate) / 1000); // ÙØ±Ù‚ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

  const statusEl = document.createElement("p");
  statusEl.style.fontSize = "14px";
  statusEl.style.color = diff < 60 ? "lime" : "#aaa";
  statusEl.style.marginTop = "4px";
  statusEl.textContent = diff < 60 ? "online" : `last seen ${formatTimeAgo(diff)}`;
  profileContainer.querySelector(".container").appendChild(statusEl);
}
function formatTimeAgo(seconds) {
  if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
  return `${Math.floor(seconds / 86400)} days ago`;
}

if (isOwner) {
  editBtn.style.display = "inline-block";
  logoutBtn.style.display = "block";

  let isEditing = false;

  // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  editBtn.onclick = () => {
  isEditing = !isEditing;
  displayNameInput.style.display = isEditing ? "block" : "none";
  saveBtn.style.display = isEditing ? "inline-block" : "none";
  bioInput.style.display = isEditing ? "block" : "none";
  bioSaveBtn.style.display = isEditing ? "inline-block" : "none";
  displayNameInput.value = data.name || "";
  bioInput.value = data.bio || "";
  editBtn.textContent = isEditing ? "âœ”" : "âœ";
};



saveAllBtn.onclick = async () => {
  const newName = displayNameInput.value.trim();
  const newBio = bioInput.value.trim().slice(0, 200);

  const valid = /^[a-zA-Z0-9._-]{3,20}$/.test(newName);
  if (!valid) return alert("âš ï¸ Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­.");

  const checkName = await getDocs(query(collection(db, "users"), where("name", "==", newName)));
  const taken = !checkName.empty && checkName.docs[0].id !== currentUser.uid;
  if (taken) return alert("âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.");

  await updateProfile(currentUser, { displayName: newName });

  await setDoc(doc(db, "users", currentUser.uid), {
    ...data,
    name: newName,
    bio: newBio,
    photo: currentUser.photoURL || data.photo
  }, { merge: true });

  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
  location.reload();
};


  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  logoutBtn.onclick = async () => {
    await signOut(auth);
    window.location.href = "/";
  };
}

}

function showMessage(msg) {
  profileContainer.innerHTML = `<div style="text-align:center;padding:100px 20px;font-size:22px">${msg}</div>`;
  showProfile();
}

function showProfile() {
  loading.style.display = "none";
  profileContainer.style.display = "block";
}
</script>
-->

</body>
</html>
