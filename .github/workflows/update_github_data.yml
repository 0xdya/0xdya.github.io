name: Update GitHub Data JSON

on:
  push:
    branches:
      - main

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install undici

      - name: Fetch GitHub Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: '0xdya/0xdya.github.io'
        run: |
          node -e "
          const fs = require('fs');
          const { fetch } = require('undici');

          async function fetchData() {
            const repo = process.env.REPO;

            const commitRes = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=1`, {
              headers: { 'Authorization': `token ${process.env.GITHUB_TOKEN}` }
            });
            const commitData = await commitRes.json();

            const releaseRes = await fetch(`https://api.github.com/repos/${repo}/releases/latest`, {
              headers: { 'Authorization': `token ${process.env.GITHUB_TOKEN}` }
            });
            const releaseData = await releaseRes.json();

            const repoRes = await fetch(`https://api.github.com/repos/${repo}`, {
              headers: { 'Authorization': `token ${process.env.GITHUB_TOKEN}` }
            });
            const repoInfo = await repoRes.json();

            const userRes = await fetch(`https://api.github.com/users/${repo.split('/')[0]}`, {
              headers: { 'Authorization': `token ${process.env.GITHUB_TOKEN}` }
            });
            const userInfo = await userRes.json();

            const contribRes = await fetch(`https://api.github.com/repos/${repo}/contributors`, {
              headers: { 'Authorization': `token ${process.env.GITHUB_TOKEN}` }
            });
            const contribData = await contribRes.json();

            const json = {
              commit: commitData[0],
              release: releaseData,
              repo: repoInfo,
              user: userInfo,
              contributors: contribData
            };

            fs.writeFileSync('docs/github_data.json', JSON.stringify(json, null, 2));
            console.log('âœ… github_data.json updated');
          }

          fetchData();
          "

      - name: Commit & Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/github_data.json
          git commit -m "Update github_data.json [ci skip]" || echo "No changes"
          git push
